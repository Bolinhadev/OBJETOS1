<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detecção de Objetos do Dia a Dia com YOLOv5n</title>
    <style>
        body { margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f0f0f0; }
        #container { position: relative; }
        video, canvas { position: absolute; top: 0; left: 0; }
    </style>
</head>
<body>
    <div id="container">
        <video id="video" width="640" height="480" autoplay muted></video>
        <canvas id="canvas" width="640" height="480"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let model;
        const classNames = ['person', 'bicycle', 'car', 'motorcycle', 'airplane', 'bus', 'train', 'truck', 'boat', 'traffic light', 'fire hydrant', 'stop sign', 'parking meter', 'bench', 'bird', 'cat', 'dog', 'horse', 'sheep', 'cow', 'elephant', 'bear', 'zebra', 'giraffe', 'backpack', 'umbrella', 'handbag', 'tie', 'suitcase', 'frisbee', 'skis', 'snowboard', 'sports ball', 'kite', 'baseball bat', 'baseball glove', 'skateboard', 'surfboard', 'tennis racket', 'bottle', 'wine glass', 'cup', 'fork', 'knife', 'spoon', 'bowl', 'banana', 'apple', 'sandwich', 'orange', 'broccoli', 'carrot', 'hot dog', 'pizza', 'donut', 'cake', 'chair', 'couch', 'potted plant', 'bed', 'dining table', 'toilet', 'tv', 'laptop', 'mouse', 'remote', 'keyboard', 'cell phone', 'microwave', 'oven', 'toaster', 'sink', 'refrigerator', 'book', 'clock', 'vase', 'scissors', 'teddy bear', 'hair drier', 'toothbrush'];

        async function setupCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            return new Promise(resolve => {
                video.onloadedmetadata = () => resolve();
            });
        }

        async function loadModel() {
            model = await tf.loadGraphModel('https://raw.githubusercontent.com/tensorflow/tfjs-models/master/yolo-v5-n/model.json');
        }

        function processInput(videoFrame) {
            const tensor = tf.tidy(() => {
                const img = tf.browser.fromPixels(videoFrame);
                const resized = tf.image.resizeBilinear(img, [640, 640]);
                const expanded = resized.expandDims(0);
                return expanded.div(255.0);
            });
            return tensor;
        }

        async function detectObjects() {
            const input = processInput(video);
            const predictions = await model.executeAsync(input);
            const boxes = await predictions[0].array();
            const scores = await predictions[1].array();
            const classes = await predictions[2].array();
            tf.dispose(predictions);
            tf.dispose(input);

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            for (let i = 0; i < boxes[0].length; i++) {
                if (scores[0][i] > 0.5) {
                    const [y, x, height, width] = boxes[0][i];
                    const class_id = classes[0][i];
                    
                    const color = `hsl(${class_id * 137.508}deg, 50%, 50%)`;
                    
                    // Desenha a caixa
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x * canvas.width, y * canvas.height, width * canvas.width, height * canvas.height);

                    // Desenha o fundo do texto
                    ctx.fillStyle = color + '80';  // 50% de opacidade
                    ctx.fillRect(x * canvas.width, y * canvas.height - 20, width * canvas.width, 20);

                    // Desenha o texto
                    ctx.fillStyle = 'white';
                    ctx.font = '16px Arial';
                    ctx.fillText(classNames[class_id], x * canvas.width + 5, y * canvas.height - 5);
                }
            }

            requestAnimationFrame(detectObjects);
        }

        async function start() {
            await setupCamera();
            await loadModel();
            video.play();
            detectObjects();
        }

        start();
    </script>
</body>
</html>
