<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detecção de Objetos YOLO v5 - Versão Robusta</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        video, canvas {
            position: absolute;
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }
        #message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
        }
        #retry-button {
            margin-top: 10px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
    </div>
    <div id="message">Inicializando...</div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const messageElement = document.getElementById('message');

        let model;
        const confidenceThreshold = 0.5;
        const classNames = ['person', 'bicycle', 'car', 'motorcycle', 'airplane', 'bus', 'train', 'truck', 'boat', 'traffic light', 'fire hydrant', 'stop sign', 'parking meter', 'bench', 'bird', 'cat', 'dog', 'horse', 'sheep', 'cow', 'elephant', 'bear', 'zebra', 'giraffe', 'backpack', 'umbrella', 'handbag', 'tie', 'suitcase', 'frisbee', 'skis', 'snowboard', 'sports ball', 'kite', 'baseball bat', 'baseball glove', 'skateboard', 'surfboard', 'tennis racket', 'bottle', 'wine glass', 'cup', 'fork', 'knife', 'spoon', 'bowl', 'banana', 'apple', 'sandwich', 'orange', 'broccoli', 'carrot', 'hot dog', 'pizza', 'donut', 'cake', 'chair', 'couch', 'potted plant', 'bed', 'dining table', 'toilet', 'tv', 'laptop', 'mouse', 'remote', 'keyboard', 'cell phone', 'microwave', 'oven', 'toaster', 'sink', 'refrigerator', 'book', 'clock', 'vase', 'scissors', 'teddy bear', 'hair drier', 'toothbrush'];

        async function setupCamera() {
            messageElement.textContent = 'Inicializando câmera...';
            const constraints = [
                { video: { facingMode: 'environment' } },
                { video: { facingMode: 'user' } },
                { video: true },
                { video: { width: { min: 640 }, height: { min: 480 } } },
                { video: { width: { min: 320 }, height: { min: 240 } } }
            ];

            for (const constraint of constraints) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia(constraint);
                    video.srcObject = stream;
                    await new Promise(resolve => {
                        video.onloadedmetadata = () => {
                            video.play();
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            resolve();
                        };
                    });
                    return;
                } catch (error) {
                    console.warn(`Falha ao usar constraint ${JSON.stringify(constraint)}:`, error);
                }
            }
            throw new Error('Não foi possível inicializar a câmera com nenhuma configuração');
        }

        async function loadModel() {
            messageElement.textContent = 'Carregando modelo YOLO v5...';
            const modelUrls = [
                'https://raw.githubusercontent.com/arnoldsandoval/yolo-tfjs-opencv/main/public/models/yolov5s/model.json',
                'https://raw.githubusercontent.com/xenova/transformers.js/main/presets/yolov5/config.json',
                // Adicione mais URLs de fallback se necessário
            ];

            for (const url of modelUrls) {
                try {
                    model = await tf.loadGraphModel(url);
                    return;
                } catch (error) {
                    console.warn(`Falha ao carregar modelo de ${url}:`, error);
                }
            }
            throw new Error('Não foi possível carregar o modelo de nenhuma fonte');
        }

        function preprocess(video) {
            return tf.tidy(() => {
                const img = tf.browser.fromPixels(video);
                const resized = tf.image.resizeBilinear(img, [640, 640]);
                const normalized = resized.div(255.0);
                return normalized.expandDims(0);
            });
        }

        async function detectObjects() {
            if (!model) return;
            tf.engine().startScope();
            const input = preprocess(video);
            try {
                const result = await model.executeAsync(input);
                const [boxes, scores, classes] = result;
                const boxesData = boxes.dataSync();
                const scoresData = scores.dataSync();
                const classesData = classes.dataSync();

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                for (let i = 0; i < boxesData.length / 4; i++) {
                    if (scoresData[i] > confidenceThreshold) {
                        const [y1, x1, y2, x2] = boxesData.slice(i * 4, (i + 1) * 4);
                        const width = x2 - x1;
                        const height = y2 - y1;

                        ctx.strokeStyle = 'red';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(x1 * canvas.width, y1 * canvas.height, width * canvas.width, height * canvas.height);

                        const className = classNames[classesData[i]];
                        const score = scoresData[i].toFixed(2);

                        ctx.fillStyle = 'red';
                        ctx.font = '16px Arial';
                        ctx.fillText(`${className} ${score}`, x1 * canvas.width, y1 * canvas.height - 5);
                    }
                }

                tf.dispose(result);
            } catch (error) {
                console.error('Erro na detecção:', error);
                messageElement.textContent = 'Erro na detecção. Tentando reiniciar...';
                await tf.nextFrame();
            }
            tf.engine().endScope();
            requestAnimationFrame(detectObjects);
        }

        async function start() {
            try {
                await setupCamera();
                await loadModel();
                messageElement.style.display = 'none';
                detectObjects();
            } catch (error) {
                console.error('Erro ao iniciar:', error);
                messageElement.innerHTML = `
                    Erro: ${error.message}<br>
                    Por favor, verifique sua conexão e as permissões da câmera.<br>
                    <button id="retry-button">Tentar Novamente</button>
                `;
                document.getElementById('retry-button').onclick = start;
            }
        }

        start();
    </script>
</body>
</html>
